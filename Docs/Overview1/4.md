Rekapitulasi mengenai skema database dan arsitektur proyek dalam bentuk diagram konseptual.

### 1. Hubungan Database: RVM Machines, Edge Devices, & Telemetry

Struktur data yang dinamis untuk sensor dan manajemen perangkat fisik, berikut adalah gambaran hubungan entitasnya.
Inti dari desain ini adalah penggunaan kolom tipe **JSONB** pada tabel telemetri untuk mengakomodasi fleksibilitas sensor tanpa perlu mengubah struktur tabel setiap kali ada sensor baru.

**Diagram Entity-Relationship (ERD Konseptual)**

```mermaid
erDiagram    
    RVM_MACHINES ||--|| EDGE_DEVICES : "has_hardware_specs"
    EDGE_DEVICES ||--o{ EDGE_TELEMETRY : "sends_sensor_data"
    RVM_MACHINES ||--o{ RVM_LOGS : "generates_logs"
    RVM_MACHINES ||--o{ TECHNICIAN_ASSIGNMENTS : "is_maintained_by"
```
```mermaid
erDiagram
    RVM_MACHINES {
        bigint id PK
        string name "Nama Lokasi/Unit"
        string serial_number "Unique ID Mesin"
        string status "online/offline/maintenance"
        decimal latitude "Lokasi Latitude"
        decimal longitude "Lokasi Longitude"
        string location "Alamat lengkap"
        int capacity_percentage "Kapasitas bin"
        timestamp last_ping "Alias: last_heartbeat"
    }

    EDGE_DEVICES {
        bigint id PK
        bigint rvm_id FK "-> rvm_machines.id"
        string device_serial "Unique Serial"
        string ip_address_local "Boleh kosong IP Address Local"
        string tailscale_ip "Boleh VPN IP Address"
        jsonb network_interfaces "Boleh kosong, JSON untuk interface IP : eth0,tailscale0, dan lain-lain"
        jsonb hardware_info "Processor, Controller, Camera, etc"
        string ai_model_version "Current AI model"
        string firmware_version
        string status "online/offline/maintenance"
        timestamp last_heartbeat "Alias: last_ping"
    }

    EDGE_TELEMETRY {
        bigint id PK
        bigint edge_device_id FK "-> edge_devices.id"
        timestamp client_timestamp "Waktu lokal Edge"
        timestamp server_timestamp "Waktu server terima"
        jsonb sensor_data "Flexible: ultrasonic, temp, etc"
        jsonb device_stats "CPU, RAM, Disk usage"
        string sync_status "synced/pending/failed"
        int sync_attempts "Retry counter"
        uuid batch_id "Group offline uploads"
    }

    RVM_LOGS {
        bigint id PK
        bigint rvm_machine_id FK
        string level "INFO, ERROR, WARN"
        text message
        jsonb context "Detail tambahan error"
        timestamp created_at
    }
```

*   **RVM_MACHINES:** Tabel utama yang menyimpan identitas logis dan status operasional mesin (box/housing).
*   **EDGE_DEVICES:** Tabel detail teknis perangkat keras yang terpasang pada mesin tersebut (Jetson Orin Nano, ESP32, konfigurasi pin). Relasinya 1:1.
*   **EDGE_TELEMETRY:** Tabel *Time-Series* untuk data sensor. Kolom `sensor_data` bertipe JSONB mendukung struktur dinamis. Dirancang untuk **offline-capable sync** dengan `sync_status` dan `batch_id`.
*   **Catatan Terminologi:** `last_ping` (istilah user) = `last_heartbeat` (istilah programming) - keduanya merujuk pada timestamp terakhir device mengirim sinyal.

---

### 2. Arsitektur Proyek MyRVM Ecosystem

Anda benar, ada 4 pilar utama dalam arsitektur proyek ini. Yang keempat adalah **RVM-Edge**.

Berikut adalah komponen lengkapnya:
1.  **RVM-Server:** Backend pusat (Laravel + PostgreSQL).
2.  **RVM-Users:** Aplikasi mobile untuk pengguna dan tenant (Flutter).
3.  **RVM-CV:** Unit komputasi GPU untuk training & validasi (Python/PyTorch).
4.  **RVM-Edge:** Unit fisik mesin RVM (Jetson Orin Nano + ESP32).

**Diagram Arsitektur Sistem**

```mermaid
graph TD
    subgraph Cloud_Infrastructure ["Server Infrastructure (VPS/Cloud)"]
        Server[("RVM-Server (Laravel 12)")]
        DB[(PostgreSQL)]
        Redis[(Redis Cache & Queue)]
        MinIO[(MinIO Object Storage)]
        Reverb[("Laravel Reverb (WebSocket)")]
        
        Server --> DB
        Server --> Redis
        Server --> MinIO
        Server --> Reverb
    end

    subgraph User_Devices ["User Layer"]
        MobileApp["RVM-Users (Flutter)"]
        User[End User / Tenant]
        
        User --> MobileApp
        MobileApp -- HTTPS API --> Server
        MobileApp -- WebSocket --> Reverb
    end

    subgraph Computing_Node ["AI Training Layer"]
        CV_Node["RVM-CV (GPU Server)"]
        Admin[Super Admin]
        
        Admin -- "Upload Dataset/Trigger" --> Server
        CV_Node -- "Fetch Data & Model" --> Server
        CV_Node -- "Push Trained Model" --> Server
        CV_Node -- "Training Status" --> Reverb
    end

    subgraph Physical_Layer ["RVM Machines (Lokasi Mesin)"]
        Edge["RVM-Edge (Jetson Orin Nano)"]
        Camera["CSI Camera (Bottle Detection)"]
        Touchscreen["LCD Touchscreen"]
        Micro["ESP32 Controller"]
        Sensors["Sensors & Actuators"]
        Motor["DC Motor (Base Platform)"]
        LED["LED Lights"]
        Bin["Bottle Storage Bin"]
        Teknisi[Teknisi Lapangan]

        Edge -- "HTTPS API (Telemetry/Trans)" --> Server
        Edge -- "WebSocket (Realtime)" --> Reverb
        Edge -- "Download Model" --> MinIO
        
        Edge --> Camera
        Edge -- Serial/UART --> Micro
        Micro -- IO --> Sensors
        Micro -- IO --> Motor
        Micro -- IO --> LED
        Edge --> Touchscreen
        
        Teknisi -- "Input PIN Maintenance" --> Touchscreen
    end
```

**Komponen Fisik RVM Machine:**
| Komponen | Status | Keterangan |
|----------|--------|------------|
| Jetson Orin Nano | WAJIB | Edge computing & AI inference |
| CSI Camera | WAJIB | Capture botol untuk deteksi |
| LCD Touch Screen | WAJIB | User interface |
| ESP32 Controller | WAJIB | Hardware I/O control |
| DC Motor | WAJIB | Buka/tutup alas botol |
| Ultrasonic Sensor | WAJIB | Deteksi level bin |
| Temperature Sensor | WAJIB | Monitor suhu internal |
| LED Lights | WAJIB | Indikator status |
| Bottle Storage Bin | WAJIB | Penampungan botol |
| *Future modules* | Opsional | Dapat ditambahkan di masa depan |

**Alur Data Utama:**
1.  **Transaksi:** Camera capture botol → Edge inference → Kirim hasil ke Server → Update saldo → Notifikasi User.
2.  **Telemetri:** Edge mengirim sensor data (JSON) setiap 30 detik. Offline mode: cache lokal, sync saat online.
3.  **AI Update:** Server simpan model baru → Edge deteksi hash baru → Download → Update lokal.
4.  **Maintenance:** Teknisi request akses → Server generate PIN → Input PIN di RVM → Masuk maintenance mode.

**Offline Mode:**
- Edge device cek koneksi dengan ping ke:
  1. `google.com` (internet availability)
  2. RVM-Server IP (server reachability)
- Jika offline: simpan data ke local storage
- Jika online: kirim batch dengan `batch_id` yang sama
- Server update `sync_status` menjadi `synced`
