# Master Integration Flow: MyRVM-Edge (Edge Control Service)

#### **Project Name:** MyRVM-Edge
#### **Version:** 2.0 (Unified Master)
#### **Status:** Production Ready
#### **Target Platform:** NVIDIA Jetson Orin Nano (JetPack 6.x)
#### **Role:** Logic Execution, Hardware Bridge, Local AI Inference, & Local/Cloud WebSocket Bridge.

---

## 1. Executive Summary
MyRVM-Edge v2.0 adalah **Master Daemon** yang mengelola integritas operasional mesin RVM secara mandiri. Menggunakan pola arsitektur **Hybrid-Communication**, perangkat ini bertindak sebagai:
1.  **Client:** Menghubungkan hardware ke Cloud (MyRVM-Server) via WebSocket (Reverb).
2.  **Server:** Menyediakan jembatan lokal (FastAPI WebSocket) untuk UI Kiosk agar tetap berfungsi 100% saat internet terputus (**Offline Guest Mode**).
3.  **Controller:** Menjalankan inferensi AI YOLO11+SAM2 dan logika validasi botol secara lokal.

---

## 2. Technical Architecture & Communication Flow

### **A. Dual-Socket Architecture**
Untuk mendukung **Offline Capability**, daemon Python menjalankan dua tugas konektivitas secara *concurrent* (bersamaan):

| Channel | Protocol | Target | Purpose |
| :--- | :--- | :--- | :--- |
| **Cloud Bridge** | WSS (Client) | Laravel Reverb | Real-time command dari Admin, Sync Transaksi Online. |
| **Local Bridge** | WS (Server) | Localhost:8888 | Menyuplai data ke Vue.js UI (Kiosk) saat Offline. |

### **B. The "Triangle" Data Flow**
1.  **UI (Browser)** ↔ **Edge (Python)**: Status sensor real-time & perintah hardware lokal.
2.  **Edge (Python)** ↔ **Server (Cloud)**: Sinkronisasi data transaksi, telemetri, dan model AI.
3.  **UI (Browser)** ↔ **Server (Cloud)**: Inisialisasi sesi QR dan otentikasi User (hanya saat online).

---

## 3. Detailed Startup Sequence (Boot Logic)

### **Step 1: Provisioning Check (Day-0)**
*   Jika `secrets.env` kosong: Jalankan **Setup Wizard (FastAPI)**.
*   Teknisi mengimpor `rvm-credentials.json` via USB atau Upload via HP (Local IP).
*   Lakukan **Smart Clean**: Cek Disk Space, bersihkan cache jika > 90%.

### **Step 2: API Handshake & Model Sync**
*   Edge memanggil `POST /api/v1/edge/handshake` membawa hardware metadata & health metrics.
*   **Response Server:** Memberikan `Signed URL Kiosk`, `WebSocket Auth Token`, dan `Target Model Version`.
*   **OTA Update:** Jika `local_version != target_version`, download `best.pt` dari GitHub Release, verifikasi SHA256, lalu hot-swap model.

### **Step 3: Service Initialization**
*   Inisialisasi `Local WebSocket Server` (Port 8888).
*   Inisialisasi `Cloud WebSocket Client` (Laravel Echo/Reverb).
*   Launch Chromium Browser: `chromium-browser --kiosk [Signed_URL_Kiosk]`.

---

## 4. AI Inference & Acceptance Logic

Pemisahan logika ini memastikan mesin tidak bisa "ditipu" oleh objek non-botol, baik saat online maupun offline.

### **A. Inference Pipeline**
1.  **Capture:** Ambil frame dari CSI Camera.
2.  **YOLO11:** Deteksi Bounding Box & Class.
3.  **Validation Rule:**
    *   **ACCEPTED:** Class `mineral` (PET) terdeteksi DAN `not_empty` TIDAK terdeteksi.
    *   **REJECTED:** Terdeteksi `soda`, `milk`, `yogurt`, `dishwasher`, `non_mineral`.
    *   **REJECTED:** Terdeteksi `mineral` tapi `not_empty` juga terdeteksi (ada cairan).

### **B. Image Handling Strategi**
*   **Accepted:** Gambar dikirim langsung ke Server (MinIO) via API Deposit. Hapus lokal segera.
*   **Rejected:** Simpan lokal selama 24 jam untuk audit teknisi, upload ke Server saat *low-traffic* (tengah malam).

---

## 5. Offline Guest Mode & Store-and-Forward

Saat internet mati, UI Kiosk (PWA) akan mendeteksi *Cloud Socket Disconnect* dan beralih ke *Local Bridge*.

### **A. Offline Operational Mode**
1.  **Login Disabled:** QR Code sesi user disembunyikan.
2.  **Guest Mode:** Layar memaksa user menggunakan "Mode Donasi".
3.  **Local Storage:** Keputusan "Accepted" disimpan ke **SQLite Lokal** (`rvm_local.db`).
    ```sql
    INSERT INTO offline_transactions (payload, status) VALUES ('{"items": "mineral", "points": 0}', 'pending');
    ```

### **B. Sync Manager (Forwarding)**
Setelah koneksi pulih:
1.  `ws_client.py` mendeteksi *reconnected*.
2.  `sync_worker.py` membaca SQLite `pending_transactions`.
3.  Kirim bulk data ke `/api/v1/edge/sync-offline`.
4.  Server mengalokasikan poin transaksi tersebut ke akun **System Donation**.

---

## 6. Directory Structure (Unified)

```text
MyRVM-Edge/
├── config/
│   ├── secrets.env       # API Key (Generated by Wizard)
│   └── config.json       # Dynamic Config (Signed URL, Model Version)
├── src/
│   ├── main.py           # Multi-tasking entry point (AsyncIO)
│   ├── setup_wizard/     # Local FastAPI for Day-0 config
│   ├── core/
│   │   ├── ai_engine.py  # YOLO11+SAM2 Inference & Acceptance Logic
│   │   ├── hardware.py   # GPIO & ESP32 UART Drivers
│   │   └── transaction.py# Logic Store (SQLite) & Forward (Sync)
│   ├── network/
│   │   ├── api_client.py # HTTP Handshake & Telemetry
│   │   ├── ws_cloud.py   # WebSocket Client (Reverb Cloud)
│   │   └── ws_local.py   # WebSocket Server (Local Bridge for UI)
│   └── utils/
│       ├── health.py     # psutil, Thermal, Smart Clean logic
│       └── updater.py    # GitHub Release OTA & SHA256 Verification
├── data/
│   ├── rvm_local.db      # SQLite for Transaction Buffer
│   └── models/           # Folder for best.pt
└── logs/                 # Rotation logs
```

---

## 7. Security & Resilience Measures

1.  **Signed URL Integrity:** URL Kiosk yang didapat dari Handshake harus divalidasi oleh Server. Jika Edge mencoba membuka URL tanpa signature, Server akan me-reject.
2.  **Local Socket Binding:** `ws_local.py` **WAJIB** di-bind ke `127.0.0.1`. Ini mencegah akses kontrol hardware dari luar perangkat (hanya browser lokal yang bisa perintah hardware).
3.  **Watchdog Timer:** Sistem menggunakan `systemd` dengan `Restart=always` untuk memastikan jika daemon Python crash, ia akan hidup kembali dalam < 5 detik.
4.  **Idempotency:** Setiap transaksi (online/offline) memiliki `client_uuid`. Server akan menolak jika mendeteksi duplikasi data saat proses sinkronisasi ulang.

---

## 8. Development Roadmap (Updated)

*   **V2.1 (Sprint 1):** Penuntasan `setup_wizard` dan `handshake` dengan Signed URL.
*   **V2.1 (Sprint 2):** Implementasi `ai_engine` dengan Acceptance Logic PET vs Not-Empty.
*   **V2.1 (Sprint 3):** Implementasi **Local Bridge & PWA Integration** (Offline Guest Mode).
*   **V2.1 (Sprint 4):** Penuntasan `sync_worker` (Store & Forward) dan Stress Test Jaringan.

---
**Dokumentasi Berakhir.**
**Revision Note:** v2.0 Menghilangkan ambiguitas antara mode online dan offline. Menyatukan visi Server-Driven UI dengan Edge-Control-Service.